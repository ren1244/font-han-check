!function(){"use strict";function t(t){let e=255&t,n=t>>8;return 129<=n&&n<=254&&(64<=e&&e<=126||161<=e&&e<=254)}function e(t){let e=255&t,n=t>>8;return 161<=n&&n<=254&&161<=e&&e<=254}function n(t){return(t=t.toString(16).toUpperCase()).length<4&&(t="0".repeat(4-t.length)),t}class i{constructor(t,e){let i=new ArrayBuffer(2),r=new DataView(i),l=new TextDecoder(e,{fatal:!0}),o={},f={};for(let e=t();null!==e;e=t()){r.setUint16(0,e);let t=l.decode(i).codePointAt(0);if(void 0!==o[t])throw`unicode ${n(t)} 重複編碼 ${n(o[t])}, ${n(e)}`;if(void 0!==f[e])throw`code ${n(e)} 重複編碼 ${n(c2t[e])}, ${n(t)}`;o[t]=e,f[e]=t}this.u2c=o,this.c2u=f}static unionArray(t){let e={};t.forEach(((t,n)=>{t.forEach((t=>{void 0===e[t]?e[t]=n:e[t]=Math.min(n,e[t])}))}));let n=Object.keys(e).map((t=>parseInt(t,10)));return n.sort(((t,n)=>{let i=e[t]-e[n];return 0!==i?i:t-n})),n}}const r={4:function(t){let e=t.getUint16(6)>>>1,n=t.byteOffset+14,i=14+2*e+2,r=i+2*e,l=r+2*e,o=new Map;for(let f=0;f<e;++f){let e=t.getUint16(i+2*f),u=t.getUint16(14+2*f),s=t.getUint16(r+2*f),a=t.getUint16(l+2*f);if(65535!==e||65535!==u)if(0===a)for(let t=e;t<=u;++t){let e=t+s&65535;o.set(t,e)}else{n=l+2*f+a;for(let i=e;i<=u;++i){let e=t.getUint16(n);n+=2,o.set(i,e)}}}return o},6:function(t){let e=t.getUint16(6),n=t.getUint16(8),i=10,r=new Map;for(let l=0;l<n;++l){let n=e+l,o=t.getUint16(i);i+=2,r.set(n,o)}return r},12:function(t){let e=t.getUint32(12),n=16,i=new Map;for(let r=0;r<e;++r){let e=t.getUint32(n);n+=4;let r=t.getUint32(n);n+=4;let l=t.getUint32(n);n+=4;for(let t=e;t<=r;++t){let n=l+t-e;i.set(t,n)}}return i}};class l{constructor(t){this.buf=t,this.dv=new DataView(this.buf),this.readTables(),this.readCmap()}readTables(){let t=this.dv.getUint16(4),e=12,n={};for(let i=0;i<t;++i){let t=this.dv.getUint32(e);t=String.fromCodePoint(t>>24&255,t>>16&255,t>>8&255,255&t);let i=this.dv.getUint32(e+8),r=this.dv.getUint32(e+12);n[t]={pos:i,len:r},e+=16}this.tables=n}readCmap(){let t=new DataView(this.buf,this.tables.cmap.pos,this.tables.cmap.len),e=t.getUint16(2),n=4,i=[];for(let r=0;r<e;++r){let e=t.getUint32(n+4),r=t.getUint16(e);i.push({platformID:t.getUint16(n),encodingID:t.getUint16(n+2),subtableOffset:e,format:r}),n+=8}const l=[[0,4],[3,10],[0,3],[3,1]];let o=null;for(let t=0;t<l.length;++t){const[e,n]=l[t];let r=i.findIndex((t=>t.platformID===e&&t.encodingID===n));if(r>=0){o=i[r];break}}if(null===o)throw"找不到可讀取的 cmap subtable";console.log(o),this.cmap=r[o.format](new DataView(t.buffer,t.byteOffset+o.subtableOffset,o.length))}getGid(t){return this.cmap.get(t)||0}}const o=new i(function(e,n){if(!t(e)||!t(n)||e>n)throw"big5 編碼區間錯誤";let i=e;return function(){if(i>n)return null;let t=255&i,e=i>>8;126===t?t=161:254===t?(t=64,++e):++t;let r=i;return i=e<<8|t,r}}(42048,50814),"big5"),f=new i(function(t,n){if(!e(t)||!e(n)||t>n)throw"gb2312 編碼區間錯誤";let i=t;return function(){if(i>n)return null;let t=255&i,e=i>>8;254===t?(t=161,++e):++t;let r=i;return i=e<<8|t,r}}(45217,55289),"gbk"),u=i.unionArray([Object.keys(o.u2c),Object.keys(f.u2c)]);document.querySelector("#file-input").addEventListener("change",(t=>{let e=new FileReader;e.onload=function(){!function(t){let e=new l(t),i="序號\tunicode\t文字\tbig5\tgbk\n";i+="-------------------------------------\n";let r=0;u.forEach((t=>{if(0===e.getGid(t)){let e=n(t),l=String.fromCharCode(t),u=void 0!==o.u2c[t]?n(o.u2c[t]):"",s=void 0!==f.u2c[t]?n(f.u2c[t]):"";i+=`${++r}\t${e}\t${l}\t${u}\t${s}\n`}})),document.querySelector("pre").textContent=i}(this.result)},e.readAsArrayBuffer(t.target.files[0])}))}();
